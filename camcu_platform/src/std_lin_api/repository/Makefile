# @file
# @brief Makefile
# @internal
#
# @copyright (C) 2019 Melexis N.V.
#
# Melexis N.V. is supplying this code for use with Melexis N.V. processor based microcontrollers only.
#
# THIS SOFTWARE IS PROVIDED "AS IS".  NO WARRANTIES, WHETHER EXPRESS, IMPLIED OR STATUTORY,
# INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE APPLY TO THIS SOFTWARE.  MELEXIS N.V. SHALL NOT IN ANY CIRCUMSTANCES,
# BE LIABLE FOR SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, FOR ANY REASON WHATSOEVER.
#
# @endinternal
#
# @details Makefile
#


#
# DEFINITIONS
#

OBJDIR ?= obj$(OBJDIR_POSTFIX)
RELEASE_DIR ?= build
LIBBASENAME ?= std_lin_api
LIBNAME ?= lib$(LIBBASENAME)
LIBRARY = $(RELEASE_DIR)/$(LIBNAME)
DEBUG ?= 2

ifeq ($(DEBUG), 3)
HIDE_CMD =
NO_OUTPUT =
else
HIDE_CMD = @
NO_OUTPUT = > /dev/null
endif


#--- Toolchain and utilities --------------------------------------------------

# GCC programs (MLX16 ones by default)
AR = mlx16-ar
CC = mlx16-gcc

# Standard utilities (MUST be in the environment PATH)
ECHO  = echo
RM    = rm -fr
CP    = cp -f
MKDIR = mkdir -p
DIFF  = diff -Nq


# --- Location to look for the sources ----------------------------------------
VPATH = src/common src/master src/slave $(GEN_DIR)
INC_COMMON_DIR = inc/common
INC_MASTER_DIR = inc/master
INC_SLAVE_DIR = inc/slave
INC_DIRS = $(INC_COMMON_DIR) $(INC_MASTER_DIR) $(INC_SLAVE_DIR)
ifdef LIN_MASTER_API
PLTF_DEFS += LIN_MASTER_API=$(LIN_MASTER_API)
endif
ifdef LIN_SLAVE_API
PLTF_DEFS += LIN_SLAVE_API=$(LIN_SLAVE_API)
endif


#--- Common directories -------------------------------------------------------
OBJDIR_MARK := $(OBJDIR)/create


#
# SOURCE FILES LIST
#

# The listed sources are only constant part which are not generated from LDF
# The top-project should build the LDF-dependent part separatelly
SRCS := lin_core.c lin_trans.c $(GEN_SRCS)
INCS := $(addprefix $(INC_COMMON_DIR)/, lin_api_compat.h lin_api_inline_impl.h lin_api.h lin_core.h lin_trans.h)

SRCS += lin_core_sl.c lin_cfg_sl.c lin_trans_sl.c
INCS += $(addprefix $(INC_SLAVE_DIR)/, lin_api_sl.h lin_cfg_sl.h lin_core_sl.h lin_trans_sl.h)

SRCS += lin_core_ma.c lin_cfg_ma.c lin_trans_ma.c
INCS += $(addprefix $(INC_MASTER_DIR)/, lin_api_ma.h lin_cfg_ma.h lin_core_ma.h lin_trans_ma.h)

OBJS  = $(patsubst %.S, $(OBJDIR)/%.o, $(filter %.S, $(SRCS)))
OBJS += $(patsubst %.c, $(OBJDIR)/%.o, $(filter %.c, $(SRCS)))

# Include automatic dependencies if exist
OBJDEPS = $(OBJS:%.o=%.d)
-include $(OBJDEPS)

CPPFLAGS_INTERNAL += $(foreach define,$(PLTF_DEFS),-D$(define))
CPPFLAGS_INTERNAL += $(foreach folder,$(INC_DIRS),-I$(folder))


#
# RULES
#

# Provide standard goals
.DEFAULT_GOAL := help


# --- Main rules --------------------------------------------------------------

.PHONY: help
help:
	@echo "Std. LIN API build environment"
	@echo
	@echo "Targets description with supported variables:"
	@echo " - all               Library build; mandatory variables: CFLAGS, ASFLAGS, INSTSET, CPPFLAGS; optional variables: GEN_DIR, GEN_SRCS, RELEASE_DIR, LIBNAME, OBJDIR_POSTFIX, LIN_SLAVE_API, LIN_MASTER_API, DEBUG"
	@echo " - clean             Remove all intermediates; optional variables: DEBUG"
	@echo " - uncrustify        Uncrustify sources (with replacement); optional variables: GEN_DIR, DEBUG"
	@echo " - uncrustify-check  Uncrustify sources (check only); optional variables: GEN_DIR, DEBUG"
	@echo " - doxy              Generate doxygen documentation; mandatory variables: GEN_DIR, LIN_SLAVE_API, LIN_MASTER_API; optional variables: DEBUG"
	@echo " - clean_doxy        Clean doxygen documentation; optional variables: DEBUG"
	@echo
	@echo "Variables description:"
	@echo " - AR              The GCC AR tool"
	@echo " - CC              The GCC CC tool"
	@echo " - CFLAGS          The *.c files build options"
	@echo " - ASFLAGS         The *.S files build options"
	@echo " - INSTSET         Instruction set"
	@echo " - CPPFLAGS        The preprocessor build options (e.g. -D/-U -I flags)"
	@echo " - RELEASE_DIR     Output library location"
	@echo " - LIBNAME         Library name"
	@echo " - OBJDIR_POSTFIX  Appends to the object folder to avoid the sources rebuild when few configurations are used"
	@echo " - GEN_DIR     Folder with files which are generated by LDF/NCF tool"
	@echo " - GEN_SRCS        Files which are generated by LDF/NCF tool"
	@echo " - LIN_SLAVE_API   Defines if LIN Slave API should be built (0 - disabled; 1 - enabled)"
	@echo " - LIN_MASTER_API  Defines if LIN Master API should be built (0 - disabled; 1 - enabled)"
	@echo " - DEBUG=2         Standard make debug level"
	@echo " - DEBUG=3         Raised make debug level"

.PHONY: all
all: $(LIBRARY).a

$(LIBRARY).a: $(OBJS)
	@$(ECHO) --- Archiving $@
	$(HIDE_CMD)$(MKDIR) $(RELEASE_DIR)
	$(HIDE_CMD)$(AR) rcs $@ $(OBJS)
	$(HIDE_CMD)$(MKDIR) $(RELEASE_DIR)/inc
	$(HIDE_CMD)$(CP) $(INCS) $(RELEASE_DIR)/inc

.PHONY: clean
clean:
	$(HIDE_CMD)$(RM) obj* build*
	$(HIDE_CMD)$(RM) *.a


#--- Default rules ------------------------------------------------------------

$(OBJDIR)/%.o:%.c $(OBJDIR_MARK)
	@$(ECHO) --- Processing: $<
	$(HIDE_CMD)$(CC) -c $(INSTSET) $(CFLAGS) $(CPPFLAGS) $(CPPFLAGS_INTERNAL) $< -o $@

$(OBJDIR)/%.o:%.S $(OBJDIR_MARK)
	@$(ECHO) --- Processing: $<
	$(HIDE_CMD)$(CC) -c $(INSTSET) $(ASFLAGS) $(CPPFLAGS) $(CPPFLAGS_INTERNAL) $< -o $@

$(OBJDIR_MARK):
	$(HIDE_CMD)-$(MKDIR) $(OBJDIR)
	$(HIDE_CMD)$(ECHO) > $(OBJDIR_MARK)


# --- Uncrustify --------------------------------------------------------------

U_CONFIG = tools/uncrustify-cfg-esw/uncrustify.cfg
U_SRCS := $(foreach dir,$(VPATH),$(wildcard $(addprefix $(dir)/,$(SRCS))))
U_SRCS += $(INCS)
ifdef GEN_DIR
U_SRCS += $(GEN_DIR)/lin_signals.c
U_SRCS += $(GEN_DIR)/lin_signals.h
endif

.PHONY: uncrustify-check
uncrustify-check:
	uncrustify -c $(U_CONFIG) --check -l C $(U_SRCS)

.PHONY: uncrustify
uncrustify:
	uncrustify -c $(U_CONFIG) --replace --no-backup -l C $(U_SRCS)


# --- LIN API doxygen generated documentation ---------------------------------

.PHONY: doxy
doxy:
	$(HIDE_CMD)$(MAKE) -f doc/doxygen/Make-doxygen.mk doxy GEN_DIR=$(GEN_DIR) LIN_MASTER_API=$(LIN_MASTER_API) LIN_SLAVE_API=$(LIN_SLAVE_API)

.PHONY: clean_doxy
clean_doxy:
	$(HIDE_CMD)$(MAKE) -f doc/doxygen/Make-doxygen.mk clean_doxy GEN_DIR=$(GEN_DIR)


#
# CHECKS FOR TARGETS DEPENDENCY ON VARIABLES
#

ifneq ($(findstring all,$(MAKECMDGOALS)),)
    ifndef CFLAGS
    $(error 'Variable CFLAGS is not defined; use 'make help' for full list of mandatory variables)
    endif
    ifndef ASFLAGS
    $(error 'Variable ASFLAGS is not defined; use 'make help' for full list of mandatory variables)
    endif
    ifndef INSTSET
    $(error 'Variable INSTSET is not defined; use 'make help' for full list of mandatory variables)
    endif
    ifndef CPPFLAGS
    $(error 'Variable CPPFLAGS is not defined; use 'make help' for full list of mandatory variables)
    endif
endif

ifneq ($(findstring doxy,$(MAKECMDGOALS)),)
    ifndef GEN_DIR
    $(error 'Variable GEN_DIR is not defined; use 'make help' for full list of mandatory variables)
    endif
    ifndef LIN_SLAVE_API
    $(error 'Variable LIN_SLAVE_API is not defined; use 'make help' for full list of mandatory variables)
    endif
    ifndef LIN_MASTER_API
    $(error 'Variable LIN_MASTER_API is not defined; use 'make help' for full list of mandatory variables)
    endif
endif
